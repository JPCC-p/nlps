# Neknaj Virtual Machine
NVMはNLPSの為の仮想マシンである

## 命令

### スタック命令
|      | 命令 | 引数  |  消費  |  追加  | スタック | 処理                         |
| ---: | ---- | :---: | :----: | :----: | :------- | ---------------------------- |
|   00 | push |   v   |   -    |   v    | +1       | スタックに値vを入れる        |
|   01 | fram |   n   |   -    | 0(n個) | +n       | スタックにn回0を入れる       |
|   02 | pop  |   -   |   v    |   -    | -1       | スタックトップの値vを1つ消す |
|   03 | popn |   n   | v(n個) |   -    | -n       | スタックトップの値vをn個消す |

### データ命令
|      | 命令  | 引数  | 消費  | 追加  | スタック | 処理                                   |
| ---: | ----- | :---: | :---: | :---: | :------- | -------------------------------------- |
|   04 | setv  |   l   |   v   |   -   | -1       | l個目のローカル変数に値vを入れる       |
|   05 | getv  |   l   |   -   |   v   | +1       | l個目のローカル変数から値vを複製する   |
|   06 | setgv |   g   |   v   |   -   | -1       | g個目のグローバル変数に値vを入れる     |
|   07 | getgv |   g   |   -   |   v   | +1       | g個目のグローバル変数から値vを複製する |
|   08 | seth  |   -   |  h v  |   -   | -2       | ヒープ領域のh番目に値vを入れる         |
|   09 | geth  |   -   |   h   |   v   | +1       | ヒープ領域のh番目から値vを複製する     |

### ジャンプ命令
|      | 命令  | 引数  |     消費      |  追加  | スタック | 処理                                                  |
| ---: | ----- | :---: | :-----------: | :----: | :------- | ----------------------------------------------------- |
|   0a | jmp   |   p   |       -       |   -    | ±0       | アドレスpまでジャンプする                             |
|   0b | ifjmp |   p   |      cn       |   -    | -1       | cnがtrueならば、アドレスpまでジャンプする             |
|   0c | call  |   p   |       -       | fp ,pc | +2       | 関数を呼ぶための処理を行い、アドレスpまでジャンプする |
|   0d | ret   |   n   | fp,pc, v(n個) |   -    | -2-n     | 関数を呼ぶ前に戻って、引数分n回popする                |


### 比較演算命令
|      | 命令 | 引数  | 消費  | 追加  | スタック | 処理   |
| ---: | ---- | :---: | :---: | :---: | :------- | ------ |
|   10 | equ  |   -   |  a b  |   v   | -1       | a == b |
|   11 | les  |   -   |  a b  |   v   | -1       | a < b  |
|   12 | grt  |   -   |  a b  |   v   | -1       | a > b  |

### 論理演算命令
|      | 命令 | 引数  | 消費  | 追加  | スタック | 処理    |
| ---: | ---- | :---: | :---: | :---: | :------- | ------- |
|   13 | not  |   -   |   a   |   v   | ±0       | not a   |
|   14 | and  |   -   |  a b  |   v   | -1       | a and b |
|   15 | or   |   -   |  a b  |   v   | -1       | a or b  |
|   16 | xor  |   -   |  a b  |   v   | -1       | a xor b |

### ビット演算命令
|      | 命令 | 引数  | 消費  | 追加  | スタック | 処理    |
| ---: | ---- | :---: | :---: | :---: | :------- | ------- |
|   17 | notb |   -   |   a   |   v   | ±0       | not a   |
|   18 | andb |   -   |  a b  |   v   | -1       | a and b |
|   19 | orb  |   -   |  a b  |   v   | -1       | a or b  |
|   1a | xorb |   -   |  a b  |   v   | -1       | a xor b |
|   1b | lsft |   -   |  a b  |   v   | -1       | a << b  |
|   1b | rsft |   -   |  a b  |   v   | -1       | a >> b  |
### 算術演算命令
|      | 命令 | 引数  | 消費  | 追加  | スタック | 処理                |
| ---: | ---- | :---: | :---: | :---: | :------- | ------------------- |
|   20 | add  |   -   |  a b  |   v   | -1       | a + b               |
|   21 | addc |   -   | a b x |  c s  | -1       | a + b 繰り上がりはc |
### 値の説明
|     |                                                  |
| --- | ------------------------------------------------ |
| a   | operand1                                         |
| b   | operand2                                         |
| x   | operand3                                         |
| c   | carry                                            |
| s   | sum                                              |
| v   | value                                            |
| n   | number                                           |
| p   | program counter (call後, ret前, jmp後, ifjmp後?) |
| pc  | program counter (call前, ret後)                  |
| fp  | frame pointer (call前, ret後)                    |
| l   | local variable                                   |
| g   | global variable                                  |
| h   | heap area address                                |
| cn  | condition                                        |

## 論理値
| 論理値 | 整数   |
| ------ | ------ |
| true   | 1 (!0) |
| false  | 0      |

## ワード長